node {

    stage('Run tests'){
        if(isUnix()){
            sh "mvn clean test"
        } else {
            bat "mvn clean test"
        }
    }

    stage('Run Tests') {
            parallel {
                stage('Test On Chrome') {
                    agent {
                        label "chrome"
                    }
                    steps {
                         bat label: 'chrome', script: 'mvn clean verify -DBROWSER=chrome -Dcucumber.options="--tags @test1"'
                         cucumber fileIncludePattern: '**/*.json', sortingMethod: 'ALPHABETICAL'
                         bat label: '', script: 'xcopy /E /I "%programfiles(x86)%\\Jenkins\\jobs\\cross-browsing pipeline demo\\builds\\%BUILD_NUMBER%\\cucumber-html-reports" "C:\\reports\\pipeline-reports\\chrome\\%BUILD_NUMBER%"'
                    }

                }
                stage('Test On Firefox') {
                    agent {
                        label "chrome"
                    }
                    steps {
                         bat label: 'firefox', script: 'mvn clean verify -DBROWSER=firefox -Dcucumber.options="--tags @test1"'
                         cucumber fileIncludePattern: '**/*.json', sortingMethod: 'ALPHABETICAL'
                         bat label: '', script: 'xcopy /E /I "%programfiles(x86)%\\Jenkins\\jobs\\cross-browsing pipeline demo\\builds\\%BUILD_NUMBER%\\cucumber-html-reports" "C:\\reports\\pipeline-reports\\firefox\\%BUILD_NUMBER%"'
                    }

    stage('Generate report'){
           cucumber failedFeaturesNumber: -1, failedScenariosNumber: -1, failedStepsNumber: -1, fileIncludePattern: '**/*.json', pendingStepsNumber: -1, skippedStepsNumber: -1, sortingMethod: 'ALPHABETICAL', undefinedStepsNumber: -1
    }

    stage('Test On Firefox') {
        agent {
            label "chrome"
    }
   steps {
          bat label: 'chrome', script: 'mvn clean verify -Dbrowser=chrome -Dcucumber.options="--tags @wip"'
          cucumber fileIncludePattern: '**/*.json', sortingMethod: 'ALPHABETICAL'
          bat label: '', script: 'xcopy /E /I "%programfiles(x86)%\\Jenkins\\jobs\\cross-browsing pipeline demo\\builds\\%BUILD_NUMBER%\\cucumber-html-reports" "C:\\reports\\pipeline-reports\\chrome\\%BUILD_NUMBER%"'
   }
}